<%- include('../partials/user/header.ejs') %>
<style>
  @media (max-width: 767.98px) {
    /* Make all text smaller on mobile */
    .card,
    .card * {
      font-size: 0.8rem !important; /* ~12px */
    }
  }
</style>

<main class="container my-4 min-vh-100">
  <% if (orders && orders.length > 0) { %> <% orders.forEach(order => { %>
  <div class="card rounded-3 px-3 px-md-4 py-3 mb-4 shadow">
    <!-- Order Header -->
    <div
      class="d-flex justify-content-between align-items-center mb-2 mb-md-3"
    >
      <span class="fw-semibold"
        >Order ID : <%=order.orderId%></span
      >
      <span class="alert alert-primary py-0 px-2 text-primery m-0"><%=order.status.charAt(0).toUpperCase() + order.status.slice(1)%></span>
    </div>

    <!-- Products Section -->
    <div class="row">
      <div
        class="col-12 col-md-9 px-2 px-md-3 py-2 rounded-2"
        style="background-color: rgb(230, 230, 230)"
      >
        <% order.products.forEach((product,index)=>{ %>
        <div
          class="row py-2 border-bottom <%=product.status === 'cancelled'?'text-secondary':''%>"
        >
          <!-- Product Image -->
          <a
            href="/products/<%=product.productId._id%>"
            class="col-3 col-md-2 d-flex align-items-center justify-content-center mb-2 mb-md-0"
          >
            <img
              src="<%=product?.image%>"
              alt="Product Image"
              class="img-fluid rounded"
              style="max-height: 90%; max-width: 100%"
            />
          </a>

          <!-- Product Info -->
          <div class="col-9 col-md-4">
            <h6 class="fw-semibold mb-1 fs-6 fs-md-5">
              <%=product?.productName%>(<%=product?.volume%> ML)
            </h6>
            <p class="fw-normal m-0 fs-7 fs-md-6">
              Price : ₹<%=product.finalAmount%>
            </p>
            <p
              class="mb-0 <%=product.status === 'cancelled'?'text-black':'text-muted'%> fs-7 fs-md-6"
            >
              Qty: <%=product.quantity%>
            </p>
            <p class="fw-bold mb-0 fs-7 fs-md-6">
              Total : ₹<%=product.subtotal%>
            </p>
          </div>

          <!-- Status -->
          <div class="col-9 col-md-3">
            <p class="small mb-1">
              <strong>Ordered On :</strong> <%=
              order.createdAt.toLocaleString('en-IN', { dateStyle: 'medium' })
              %>
            </p>
            <p class="small mb-1">
              <strong>Expected :</strong> <%= new Date(order.createdAt.getTime()
              + 1000*60*60*24*3).toLocaleString('en-IN', { dateStyle: 'medium'
              }) %>
            </p>
            <p class="small mb-0">
              <strong>Status : </strong>
              <span
                class="<%=product.status === 'cancelled'?'text-secondary':'text-success'%> fw-bold"
              >
                <%=product.status.charAt(0).toUpperCase()+product.status.slice(1)%>
              </span>
            </p>
            <p class="small mb-1">
              <strong>Payment Method :</strong> <%=order.payment.method%>
            </p>
          </div>

          <!-- Actions -->
          <div
            class="col-3 col-md-3 d-flex gap-2 justify-content-end align-items-center"
          >
            <% if(!["shipped","Out of delivery","delivered","cancelled","returned"].includes(product.status)) { %>
            <button
              class="btn btn-danger fs-7 fs-md-6"
              onclick="cancelOrderProduct('<%=order._id%>','<%=index%>')"
            >
              Cancel
            </button>
            <% } %>
            <% if(product.status === 'delivered'&&product.return?.returnTimeLimit>Date.now()) { %>
            <button
              class="btn btn-secondary fs-7 fs-md-6"
              data-bs-toggle="modal"
              data-bs-target="#returnModal"
              onclick="openReturnModal('<%= order._id %>', '<%= index %>')"
            >
              <%= product.return?.isRequested ? "Requested" : "Return" %>
            </button>
            <% } %>

            <a
              href="/orders/details/<%=order._id%>?index=<%=index%>"
              class="btn btn-dark fs-7 fs-md-6"
              >Details</a
            >
          </div>

          <div
            class="col-12 <%=!product.return?.adminReason?'d-none':''%> "
          >
            <span class="text-danger fw-normal small fw-semibold"
              >Return Rejected Reason :
              <span><%=product.return.adminReason%></span></span
            >
          </div>
        </div>
        <% }) %>
      </div>

      <!-- Price Details -->
      <div
        class="col-12 col-md-3 d-flex justify-content-center mt-2 mt-md-0 p-0 ps-md-2"
      >
        <div class="row rounded-3 gap-2 w-100">
          <div
            class="p-3 rounded-3 col-12"
            style="background-color: rgb(230, 230, 230)"
          >
            <h6 class="fw-bold mb-3 fs-6 fs-md-5">Price Details</h6>
            <div class="d-flex justify-content-between mb-2 fs-7 fs-md-6">
              <span>Items (<%=order.products.length%>)</span>
              <span>₹<%=order.totalOrderPrice%></span>
            </div>
            <div
              class="d-flex justify-content-between mb-2 fs-7 fs-md-6 <%=order.products.some(o=>o.status=='cancelled'||o.status === 'returned')?'':'d-none'%>"
            >
              <span>Refunded Amount</span>
              <span class="text-dark">₹<%=order.refundAmount%></span>
            </div>
            <div
              class="d-flex justify-content-between mb-2 fs-7 fs-md-6 <%=order.couponApplied?'':'d-none'%>"
            >
              <span>Discount</span>
              <span class="text-success"
                ><%=order.couponDiscount?order.couponDiscount+'%':'No Discounts'%></span
              >
            </div>
            <div
              class="d-flex justify-content-between mb-2 fs-7 fs-md-6 <%=order.couponApplied?'':'d-none'%>"
            >
              <span>Discount Amount</span>
              <span class="text-danger"
                >-₹<%=parseFloat(((order.totalOrderPrice-order.refundAmount)*order.couponDiscount/100).toFixed(2))%></span
              >
            </div>
            <div class="d-flex justify-content-between mb-2 fs-7 fs-md-6">
              <span>Delivery Charge</span>
              <span class="text-success">₹<%=order.deliveryCharge%></span>
            </div>
            <div
              class="d-flex justify-content-between border-top pt-2 fw-bold fs-6 fs-md-5"
            >
              <span>Total Amount</span>
              <span>₹<%=order.finalAmount%></span>
            </div>
          </div>

          <div
            class="alert alert-dark p-2 rounded-3 col-12 fs-7 fs-md-6 <%=!order.return?.adminReason?'d-none':''%>"
          >
            <p class="text-dark m-0 p-0 fw-bold text-start">
              Return request rejected
            </p>
            <span class="text-dark fw-semibold text-start"
              >Reason : <span><%=order.return.adminReason%></span></span
            >
          </div>
        </div>
      </div>
    </div>

    <!-- Order-level actions -->
    <div
      class="d-flex justify-content-between align-items-center mt-md-3 mt-2 gap-2"
      style="max-height: fit-content !important"
    >
      <% if(!["delivered","cancelled","returned"].includes(order.status)) { %>
      <button
        class="btn btn-outline-dark btn-sm fw-semibold"
        onclick="cancelOrder('<%=order._id%>')"
      >
        Cancel Order
      </button>
      <% } %> <%if(order.status=='delivered'){%>
      <button
        class="btn btn-sm btn-secondary"
        data-bs-toggle="modal"
        data-bs-target="#returnModal"
        onclick="openReturnModal('<%= order._id %>')"
      >
        <%= order.return?.isRequested ? "Return Requested" :
        order.return?.adminReason ? "Return Rejected" : "Return Order" %>
      </button>
      <%}%>

      <div class="text-start">
        <a
          href="/orders/<%=order._id%>/invoice"
          class="btn btn-outline-primary btn-sm fw-bold"
          >Invoice</a
        >
      </div>
    </div>

    <div class="mt-2 fs-8">
      <span class="text-danger small fw-semibold"
        >* If you return/cancel any product and used a coupon, the coupon amount
        will be reduced from your refund.</span
      >
    </div>
  </div>
  <% }) %> <% } else { %>
  <div class="text-center py-5">
    <h5 class="text-muted">You have no orders yet.</h5>
    <a href="/shop" class="btn btn-dark mt-2">Shop Now</a>
  </div>
  <% } %>

  <!-- Return Modal -->
  <div
    class="modal fade"
    id="returnModal"
    tabindex="-1"
    aria-labelledby="returnModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="returnForm">
          <div class="modal-header">
            <h5 class="modal-title fs-6 fs-md-5" id="returnModalLabel">
              Return Order
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>

          <div class="modal-body">
            <div class="mb-3">
              <label for="returnReason" class="form-label fs-7 fs-md-6"
                >Reason for return</label
              >
              <textarea
                id="returnReason"
                class="form-control w-100 fs-7 fs-md-6"
                rows="3"
                placeholder="Enter your reason"
              ></textarea>
            </div>
          </div>

          <div class="modal-footer">
            <button type="submit" class="btn btn-primary fs-7 fs-md-6">
              Submit
            </button>
            <button
              type="button"
              class="btn btn-secondary fs-7 fs-md-6"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</main>

<script>
  let currentReturnId = null;
  let currentReturnIndex = null;

  function openReturnModal(id, index = null) {
      if(!confirm('Are you sure you want to Return')) return
    currentReturnId = id;
    currentReturnIndex = index;

    const reasonInput = document.getElementById("returnReason");
    if (reasonInput) reasonInput.value = "";

    const modalEl = document.getElementById("returnModal");
    if (modalEl) new bootstrap.Modal(modalEl).show();
  }

  document
    .getElementById("returnForm")
    .addEventListener("submit", async (e) => {
      e.preventDefault();
      const reason = document.getElementById("returnReason").value.trim();
      if (!reason) {
        alert("Please provide a return reason.");
        return;
      }

      let url =
        currentReturnIndex !== null
          ? `/orders/product/return/${currentReturnId}?index=${currentReturnIndex}`
          : `/orders/return/${currentReturnId}`;

      try {
        const res = await fetch(url, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ reason }),
        });
        const data = await res.json();
        if (data.status) location.reload();
        else alert(data.message || "Return request failed");
      } catch (err) {
        console.error(err);
        alert("Unable to return");
      }
    });

  async function cancelOrderProduct(id, index) {
    try {
      if(!confirm('Are you sure you want to Cancel')) return
      const res = await fetch(`/orders/product/cancel/${id}?index=${index}`, {
        method: "PATCH",
      });
      const data = await res.json();
      if (data.status) location.reload();
    } catch (err) {
      console.error(err);
      alert("Unable to cancel product");
    }
  }

  async function cancelOrder(id) {
    try {
      if(!confirm('Are you sure you want to Cancel')) return
      const res = await fetch(`/orders/cancel/${id}`, { method: "PATCH" });
      const data = await res.json();
      if (data.status) location.reload();
    } catch (err) {
      console.error(err);
      alert("Unable to cancel order");
    }
  }
</script>

<%- include('../partials/user/footer.ejs') %>
