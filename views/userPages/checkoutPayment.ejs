<%-include('../partials/user/header.ejs')%>

<style>
  body {
    background-color: #fff;
    font-family: Arial, sans-serif;
  }
  .shopping-bag-title {
    font-weight: bold;
    text-align: center;
    margin: 30px 0;
    font-size: 1.8rem;
    letter-spacing: 2px;
  }
  .card {
    border: none;
  }
  .item-img {
    max-width: 100px;
  }
  .order-summary {
    background: #f5f5f5;
    padding: 20px;
    border-radius: 6px;
  }
  .order-summary h5 {
    font-weight: bold;
    margin-bottom: 20px;
  }
  .order-summary .summary-line {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    font-size:small;
  }
  .apply-btn {
    background: black;
    color: white;
    border: none;
  }
  .in-stock {
    color: green;
    font-size: 0.9rem;
  }
  .remove-btn {
    font-size: 0.85rem;
    color: red;
    background: none;
    border: none;
    padding: 0;
    text-decoration: underline;
    cursor: pointer;
  }
</style>

<main>
  <div class="px-md-5 px-3">
    <div class="shopping-bag-title">PAYMENT METHODS</div>
    <div class="row">
      <!-- Left Side: Shopping Items -->
      <div class="col-lg-9">
        <div class="p-3 bg-light rounded-3">
          <% paymentMethods.forEach((method, i) => { %>
          <div class="card mb-2 border-0 shadow-sm" onclick="selectMethod(this)">
            <div class="card-body d-flex align-items-center">
              <!-- Radio -->
              <div class="form-check me-3">
                <input
                  class="form-check-input" 
                  type="radio"
                  name="paymentMethod"
                  id="pay_<%= method.code %>"
                  value="<%=method.code %>" 
                  <%=method.code=='COD'&&Number(total)>7000?'disabled':''%>
                  <%= i==0&&total<7000 || i=== 1 ? "checked" : "" %>>
              </div>

              <div class="flex-grow-1">
                <h6 class="mb-0 fw-semibold <%=total>7000&&method.code=='COD'?'text-secondary':''%>">
                  <%= method.name %>
                </h6>
              </div>
            </div>
          </div>
          <% }) %>
        </div>
      </div>

      <!-- Right Side: Order Summary -->
      <div class="col-md-3 mt-3 m-md-0">
        <div class="order-summary shadow-sm">
          <h5>Order Summary</h5>

          <%items.forEach((item,index)=>{%>
          <div class="summary-line">
            <span
              ><%= item.quantity %> × <%= item.product.name %> (<%=
              item.variant.volume %>ml)</span
            >
            <span
              >Rs.<%= ((item.variant.finalAmount) *
              item.quantity).toLocaleString() %></span
            >
          </div>
          <% }) %>

          <div class="summary-line text-dark fs-6 fw-semibold">
            <span>Total Amount</span><span>₹<%=total-deliveryCharge%></span>
          </div>
          <div class="summary-line text-success">
            <span>Delivery Charges</span><span>₹<%=deliveryCharge||'Free'%></span>
          </div>
          <div class="summary-line text-success">
            <span>Coupon discount percentage</span><span id="couponDiscPerc">0%</span>
          </div>
          <div class="summary-line text-dark">
            <span>Coupon discount</span><span id="couponDisc" class="text-danger">0</span>
          </div>
          <div class="summary-line fw-bold fs-5">
            <span>Total</span><span id="totalAmount">Rs.<%=total%></span>
          </div>
          <div class="input-group mt-3 mb-3">
            <input
              type="text"
              class="form-control"
              name="coupon"
              id="coupon"
              placeholder="Discount code"
            />
            <button id="couponApplyBtn" class="btn btn-dark">Apply</button>
          </div>
          <a id="cancelCoupon" class="text-decoration-none m-0" onclick="cancelCoupon()"></a>
          <div id="couponMessage" class="text-danger small mt-2"></div>
          <div class="d-flex justify-content-center">  
            <button id="continue"
              class="btn btn-dark text-decoration-none fw-bold w-100">
              Place Order
            </button>
          </div>
        </div>
                <!-- coupons -->
        <div class="mt-4">
          <h5 class="fw-bold mb-2"><i class="fa-solid fa-tags"></i> <%=!coupons.length?'No':''%> Available Coupons</h5>
            <div id="couponList" class="list-group w-md-75">
              <!-- Example coupon -->
              <%coupons.forEach(c=>{%>
              <div class="list-group-item d-flex justify-content-between align-items-center rounded-4 mb-2 shadow-sm">
                <div>
                  <span class="fw-bold"><%=c.code%></span>
                  <small class="d-block text-muted">Get <%=c.discount%>% off on orders above ₹<%=c.minPrice%></small>
                </div>
                <button class="btn btn-outline-dark btn-sm rounded-4 copy-coupon" data-code="<%=c.code%>">Copy</button>
              </div>
              <%})%>
            </div>
          </div>
      </div>
    </div>
  </div>
  <!-- Payment Failed Modal -->
<div class="modal fade" id="paymentFailedModal" tabindex="-1" aria-labelledby="paymentFailedLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-danger">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="paymentFailedLabel">Payment Failed</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="paymentFailedMessage">Your payment could not be processed. Please try again.</p>
      </div>
      <div class="modal-footer">
        <button type="button" id="retry" class="btn btn-outline-danger" >Retry</button>
        <!-- <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button> -->
      </div>
    </div>
  </div>
</div>

</main>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script defer>
  document.getElementById("continue").addEventListener("click", async (e) => {
  e.preventDefault();

  try {
    //Get selected payment method and coupon code
    const paymentMethod = document.querySelector(
      'input[name="paymentMethod"]:checked'
    )?.value;

    if (!paymentMethod) throw new Error("Please select a payment method.");

    //Place order via backend
    const response = await fetch("/checkout/api/placeOrder", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ paymentMethod}),
    });

    const data = await response.json();

    if (!data.status) return showPaymentFailedModal(`Payment Failed :- ${data.message}`);

    // If Razorpay, open Razorpay checkout
    if (paymentMethod === "RAZORPAY" && data.razorpayOrderId) {
      const options = {
        key: "<%= process.env.RAZORPAY_KEY_ID %>", // Razorpay key
        amount: data.totalAmount * 100, // paise
        currency: "INR",
        name: "VENICARA",
        order_id: data.razorpayOrderId,
        prefill: {
          name: "<%= user.name %>",
          email: "<%= user.email %>",
          contact: "<%= user.mobile %>",
        },
        theme: { color: "#3399cc" },
        handler: async function (response) {
          try {
            const res = await fetch("/checkout/api/razorpay/success", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                orderId: data.orderId,
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_order_id: response.razorpay_order_id,
                razorpay_signature: response.razorpay_signature,
              }),
            });

            const result = await res.json();
            if (result.status) {
              window.location.href = `/checkout/placeOrder/${data.orderId}`;
            } else {
            showPaymentFailedModal("Payment Failed - "+result.message);
            return
            }
          } catch (err) {
            showPaymentFailedModal("Payment Failed - Due to Internal Error");
            return;
          }
        },
        modal: { escape: true, ondismiss: async() => {
          try{
            const response = await fetch('/checkout/api/razorpay/failed', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ orderId: data.orderId })
            });
            const result = await response.json();
            showPaymentFailedModal(result.message) 

          }catch(error){
            console.log('razorpay ondismiss'+error)
          }
        }
        }
      };

      const rzp = new Razorpay(options);
      rzp.open();
      return; // Stop further redirect
    }


    // For non-Razorpay methods, redirect to order page
    window.location.href = `/checkout/placeOrder/${data.orderId}`;
  } catch (err) {
    showPaymentFailedModal("Payment Failed - "+err.message);
    return
  }
});



    document.getElementById('retry').addEventListener('click',()=>{
      window.location.replace('/orders')
    })

  // Function to show payment failed modal
function showPaymentFailedModal(message = "Your payment could not be processed. Please try again.") {
  const modalEl = document.getElementById("paymentFailedModal");
  const messageEl = document.getElementById("paymentFailedMessage");
  messageEl.textContent = message;

  const modal = new bootstrap.Modal(modalEl);
  modal.show();
}


  //coupen copy
   document.getElementById('couponList').addEventListener('click', async(e) => {
     if (e.target.classList.contains('copy-coupon')) {
       const code = e.target.getAttribute('data-code');
       navigator.clipboard.writeText(code).then(() => {
         e.target.textContent = "Copied!";
         setTimeout(() => e.target.textContent = "Copy", 1500);
       });
     }
   });

  //Coupon applay
  document.getElementById('couponApplyBtn').addEventListener('click',async(e)=>{
    e.preventDefault()
    const code=document.getElementById('coupon').value
    const cartId=document.getElementById('coupon').value
    try{
      const res=await fetch('/checkout/api/coupon/apply',{
        method:'PATCH',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({code,cartId})
      })
      const data=await res.json()
      if(data.status){
        document.getElementById('couponApplyBtn').innerHTML = `${data.message}`
        document.getElementById('coupon').readOnly=true
        document.getElementById('couponDisc').innerHTML = `-₹${data.discount}`
        document.getElementById('totalAmount').innerHTML = `Rs.${data.finalAmount}`
        document.getElementById('couponDiscPerc').innerHTML = `${data.discPerc}%`
        document.getElementById('cancelCoupon').innerHTML = `Cancel coupon`
      }else{
        document.getElementById('couponMessage').innerHTML = `${data.message}`
      }
    }catch(error){
      showAlert('error',error.message)
    }
  })

  document.getElementById('canelCoupon').addEventListener('click',async(e)=>{
    const code=document.getElementById('coupon').value
    try{
      const res=await fetch('/checkout/api/coupon/apply',{
        method:'PATCH',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({code})
      })
      const data=await res.json()
      if(data.status){
        document.getElementById('couponMessage').classList.add('d-none')
        document.getElementById('couponApplyBtn').innerHTML = `${data.message}`
        document.getElementById('couponDisc').innerHTML = `Rs.${data.discount}`
        document.getElementById('totalAmount').innerHTML = `Rs.${data.finalAmount}`
        document.getElementById('couponDiscPerc').innerHTML = `${data.discPerc}%`
        document.getElementById('cancelCoupon').innerHTML = `Cancel coupon`
      }else{
        document.getElementById('couponMessage').classList.remove('d-none')
        document.getElementById('couponMessage').innerHTML = `${data.message}`
      }
    }catch(error){
      showAlert('error',error.message)
    }
  })

  //cancel coupon
  async function cancelCoupon(){
    const res=await fetch('/checkout/api/coupon/cancel',{
      method:'PATCH',
    })
    const data=await res.json()
    if(data.status){
      window.location.reload()      
    }
  }

  function selectMethod(card){
    const input = card.querySelector('input[type="radio"]');
    if(input && !input.disabled){
      input.checked = true
    }
  }
</script>

<%-include('../partials/user/footer.ejs')%>
