<%-include('../partials/user/header.ejs')%>
  <%-include('../partials/user/sidebarProfile.ejs')%>
  <style>
    .clickImg{
      z-index: 1000;
      padding:.5rem .5rem;
      font-size: 8px;
      border-radius: 20px;
      right:-6rem;
      top:0
    }
  </style>
    <main class="flex-grow-1 bg-light w-100 justify-content-center d-flex">

      <div style="width:50rem" class="mt-5 rounded-4 shadow h-auto px-5 pt-5">
        <div>
          <p class="fs-3 fw-bold text-black text-center">Edit Profile</p>
        </div>
        <form action="/profile/edit?_method=PATCH" method="POST" enctype="multipart/form-data">
          <div class="row">
            <div class="col-md-12 w-100 d-flex justify-content-center">
              <div class="position-relative d-inline-block">
                <!-- Circle -->
                <div id="addImg" class=" rounded-circle overflow-hidden"
                  style="width:7rem;height:7rem;cursor:pointer;background:rgb(160, 152, 152)">
                  <input name="userProfile" id="userProfile" type="file" hidden>
                  <input name="oldImg" id="oldImg" value="<%=user.public_id%>" type="hidden">

                  <% if (user.photoUrl) { %>
                    <!-- Show uploaded profile picture -->
                    <img src="<%= user.photoUrl %>" alt="Profile" loading="lazy" class="w-100 h-100 rounded-circle"
                      style="object-fit:cover;">
                    <% } else { %>
                      <div class="w-100 h-100 rounded-circle d-flex align-items-center justify-content-center">
                        <span class="text-white fw-bold" style="font-size: 2.75rem;"><%= user.name.charAt(0) %></span>
                      </div>
                      <% } %>
                      <div id="clickImg" class="position-absolute bg-dark text-white clickImg d-none">Click to add image</div>
                </div>

                

                <!-- Delete button sits OUTSIDE the circle -->
                <button type="button" id="deleteBtn"
                  class="btn btn-sm btn-light border position-absolute <%= user.photoUrl ? '' : 'd-none' %>"
                  style="bottom:0px; right:0px; border-radius:50%; padding:0.2rem 0.4rem;">
                  <i class="fa-solid fa-trash"></i>
                </button>
              </div>
            </div>

            <div class="col-md-6 mx-auto mt-5">
              <div class="mb-3">
                <label for="name" class="fw-bold">Name:</label>
                <input type="text" id="name" name="name" class="form-control rounded-3" value="<%=user.name%>">
              </div>
              <div class="mb-3">
                <label for="email" class="fw-bold">Email:</label>
                <input type="email" id="email" name="email" class="form-control rounded-3" value="<%=user.email%>">
              </div>
              <div class="mb-3">
                <label for="phone" class="fw-bold">Phone:</label>
                <input type="tel" pattern="[0-9]{10}" id="phone" name="phone" class="form-control rounded-3"
                  value="<%=user.mobile?user.mobile:''%>" placeholder="Enter your Mobile number">
              </div>

              <!-- Gender -->
              <div class="mb-3">
                <label class="fw-bold d-block">Gender:</label>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="gender" id="female" value="female"
                    <%=user.gender&&user.gender==='female' ?'checked':''%> >
                  <label class="form-check-label" for="female">Female</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="gender" id="male" value="male"
                    <%=user.gender&&user.gender==='male' ?'checked':''%> >
                  <label class="form-check-label" for="male">Male</label>
                </div>
              </div>
            </div>
            <div class="col-md-12 d-flex justify-content-between px-5 pb-5">
              <a href="/profile/changePassword" class="text-primary text-decoration-none <%=!user.password?'d-none':''%>"
                >Change password</a>
              <div class="<%=user.password?'d-none':''%>"
                ></div>
              <button type="submit" class="btn btn-dark px-4">Save changes</button>
            </div>
          </div>
        </form>
      </div>
    </main>
    </div>
    <script>
      const addImg = document.getElementById("addImg");
      const userProfile = document.getElementById("userProfile");
      const deleteBtn = document.getElementById("deleteBtn");

      async function restorePlaceholder() {
        [...addImg.children].forEach((child) => {
          if (child.tagName !== "INPUT") child.remove();
        });

        const public_id = document.getElementById('oldImg').value

        const iconSmall = document.createElement("div");
        iconSmall.className = "rounded-circle bg-dark mt-3";
        iconSmall.style.cssText = "width:40%;height:40%;margin-left:1.8rem";

        const iconLarge = document.createElement("div");
        iconLarge.className = "rounded-circle bg-dark mt-1";
        iconLarge.style.cssText = "width:80%;height:80%;margin-left:.6rem";

        addImg.appendChild(iconSmall);
        addImg.appendChild(iconLarge);

        const res = await fetch('/profile/api/deleteProfile',{
          method:'PATCH',
          headers:{"Content-Type":'application/json'},
          body:JSON.stringify({public_id})
        })
        const data=await res.json()
        if(data.status){
          showAlert('success',data.message)
          userProfile.value = "";
          deleteBtn.classList.add("d-none");
        }else{
          showAlert('error',data.message)
        }
      }

      addImg.addEventListener("click", () => userProfile.click());

      userProfile.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
          [...addImg.children].forEach((child) => {
            if (child.tagName !== "INPUT") child.remove();
          });

          const img = document.createElement("img");
          img.src = event.target.result;
          img.className = "w-100 h-100 rounded-circle";
          img.style.objectFit = "cover";
          addImg.appendChild(img);

          deleteBtn.classList.remove("d-none");
        };
        reader.readAsDataURL(file);
      });

      deleteBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        restorePlaceholder();
      });

      document.getElementById('addImg').addEventListener('mouseenter',(e)=>{
        document.getElementById('clickImg').classList.remove('d-none')
      })
      document.getElementById('addImg').addEventListener('mouseleave',(e)=>{
        document.getElementById('clickImg').classList.add('d-none')
      })
    </script>
    </body>

    </html>