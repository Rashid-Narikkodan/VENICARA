<%-include('../partials/user/header.ejs')%>

<style>
  body {
    background-color: #fff;
    font-family: Arial, sans-serif;
  }
  .shopping-bag-title {
    font-weight: bold;
    text-align: center;
    margin: 30px 0;
    font-size: 1.8rem;
    letter-spacing: 2px;
  }
  .card {
    border: none;
  }
  .item-img {
    max-width: 100px;
  }
  .order-summary {
    background: #f5f5f5;
    padding: 20px;
    border-radius: 6px;
  }
  .order-summary h5 {
    font-weight: bold;
    margin-bottom: 20px;
  }
  .order-summary .summary-line {
    display: flex;
    justify-content: space-between;
    margin-bottom: .5rem;
    font-size:x-small;
  }
  .apply-btn {
    background: black;
    color: white;
    border: none;
  }
  .in-stock {
    color: green;
    font-size: 0.9rem;
  }
  .remove-btn {
    font-size: 0.85rem;
    color: red;
    background: none;
    border: none;
    padding: 0;
    text-decoration: underline;
    cursor: pointer;
  }
</style>

<main>
  <div class="container">
    <div class="shopping-bag-title">SELECT ADDRESS</div>
    <div class="row">
      <!-- Left Side: Shopping Items -->
      <div class="col-lg-9">
  <% if (addresses && addresses.length > 0) { %>
    <div class="p-3 bg-light rounded-3">
      <% addresses.forEach((addr, i) => { %>
        <div class="card mb-3 border-0 shadow-sm <%= i === 0 ? 'bg-light' : '' %>">
          <div class="card-body d-flex align-items-start">
            <!-- Radio button -->
            <div class="form-check me-3">
              <input class="form-check-input" type="radio" name="selectedAddress" 
                     id="address_<%= addr._id %>" 
                     value="<%= addr._id %>" 
                     <%= i === 0 ? 'checked' : '' %>>
            </div>

            <!-- Address details -->
            <div class="flex-grow-1">
              <h6 class="mb-1 fw-bold">
                <%= addr.fullName %> &nbsp; <%= addr.mobile %>
              </h6>
              <p class="mb-1 small text-muted">
                <%= addr.address %>, <%= addr.city %>, <%= addr.pin %>
              </p>
            </div>

            <!-- Address type + edit -->
            <div class="text-end">
              <span class="badge bg-secondary"><%= addr.type %></span>
              <a href="/checkout/address/edit/<%= addr._id %>" class="ms-2 text-decoration-none">
                âœŽ
              </a>
            </div>
          </div>
        </div>
      <% }) %>

      <!-- Add new address button -->
      <div class="text-center mt-3">
        <a href="/checkout/address/new" class="btn btn-outline-dark w-100 rounded-3">
          + Add a new address
        </a>
      </div>
    </div>
  <% } else { %>
    <div class="alert alert-info">No addresses found. Add a new one.</div>
    <a href="/checkout/address/new" class="btn btn-dark">+ Add a new address</a>
  <% } %>
</div>


      <!-- Right Side: Order Summary -->
      <div class="col-md-3">
        <div class="order-summary shadow-sm">
          <h5>Order Summary</h5>

        <% let total = 0;
        items.forEach((item,index) => { 
        let lineTotal = (item.variant.finalAmount)* item.quantity;
        total += lineTotal; %> 
          <div class="summary-line">
            <span
              ><%= item.quantity %> Ã— <%= item.product.name %> (<%=
              item.variant.volume %>ml)</span
            >
            <span
              >Rs.<%= ((item.variant.finalAmount) *
              item.quantity).toLocaleString() %></span
            >
          </div>
          <% }) %>

          <div class="summary-line text-success">
            <span>Delivery Charges</span><span>Free</span>
          </div>

          <div class="summary-line fw-bold fs-5">
            <span>Total</span><span>Rs.<%=total%></span>
          </div>
          <div class="d-flex justify-content-center">
            <button id="continue" class="btn btn-dark text-decoration-none w-100">CONTINUE</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>
<script>
  document.getElementById('continue').addEventListener('click', async (e) => {
    e.preventDefault();

    // 1. Get selected radio value
    const selectedAddress = document.querySelector('input[name="selectedAddress"]:checked')?.value;

    if (!selectedAddress) {
      alert("Please select an address.");
      return;
    }

    // 2. Send fetch request
    try {
      const response = await fetch('/checkout/address/selectAddress', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'   // ðŸ‘ˆ required
        },
        body: JSON.stringify({ selectedAddress })
      });

      const data = await response.json();

      if (data.status) {
        window.location.href = "/checkout/paymentMethod";
      } else {
        alert(data.message || "Something went wrong.");
      }
    } catch (err) {
      console.error(err);
      alert("Server error.");
    }
  });
</script>

<%-include('../partials/user/footer.ejs')%>
