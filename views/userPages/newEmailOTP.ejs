<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title><%=title%></title>
  <link
   href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
   rel="stylesheet"
  />
  <link rel="stylesheet" href="/css/userAuth.css" />
 </head>
 <body class="vh-100 d-flex align-items-center">
  <div class="container text-center d-flex justify-content-center">
   <div
    class="card shadow-lg border-0 rounded-5 overflow-hidden mt-3"
    style="max-width: 800px; width: 100%"
   >
    <div class="row g-0 d-flex justify-content-center pt-md-2 pb-md-5">
            <div class="col-md-12 py-4">
        <img src="/images/logo.avif" class="img-fluid" alt="" style="width:13rem">
      </div>
      <!-- Left Image Section -->
     <div
      class="col-md-6 d-none d-md-flex align-items-center justify-content-center"
     >
      <img
       src="/images/b&w.avif"
       alt="Signup"
       class="object-fit-cover img-fluid rounded-4 img-login"
      />
     </div>
     <!-- Right Form Section -->
     <div class="col-md-5 p-5">
      <div class="col-12 mb-md-3">
              <h2 class="mb-2">Confirm with OTP</h2>
              <p>Please check your mail address for OTP</p>
            </div>
      <%if(messages.error.length>0){%>
      <div class="alert alert-danger p-2"><%=messages.error[0]%></div>
      <%}%>
      <!-- Form -->
      <div class="row g-0 d-flex justify-content-center pt-md-3 pb-md-5">
              <form action="/profile/edit/otp" method="post" class="">
                <input type="text" name="otp" placeholder="Enter OTP" class="p-3 mb-md-3 text-center w-100 form-control" maxlength="6">
                <input type="hidden" id="email" value="<%=email%>" name="email">
                <div class="mb-3 mt-3">
                  <span>Remaining Time <span id="timer" style="color:blueviolet" >00:50s</span></span>
                  <br class=" d-block">
                  <span class="">Didnâ€™t you receive code? <a href="#" id="resend-otp" class="text-decoration-none"><span style="color:blueviolet">Resend</span></a></span>
                </div>
                <button class="btn btn-dark w-75  mb-3 p-md-3 p-2" type="submit">Confirm</button>
              </form>

      <p class="mt-3 text-center text-muted">
       <a href="/profile/edit" class="fw-semibold text-decoration-none text-secondary">Go back to Profile Edit page?</a>
      </p>
     </div>
     
    </div>
   </div>
  </div>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const resend = document.getElementById('resend-otp');
    const timer = document.getElementById('timer');
    const successOTP = document.getElementById('success-otp');
    let timerId;

    // --- Function: Start Timer ---
    function startTimer(seconds) {
      if (timerId) clearInterval(timerId);
      let i = seconds;

      resend.style.pointerEvents = 'none';
      resend.innerHTML = 'wait...';
      timer.innerHTML = `00:${i < 10 ? '0' + i : i}s`;

      timerId = setInterval(() => {
        i--;
        timer.innerHTML = `00:${i < 10 ? '0' + i : i}s`;
        if (i <= 0) {
          clearInterval(timerId);
          timer.innerHTML = `00:00s`;
          resend.innerHTML = 'Resend';
          resend.style.pointerEvents = 'auto';
        }
      }, 1000);
    }

    // --- Function: Resend OTP ---
    resend.addEventListener('click', async (e) => {
      e.preventDefault();
      resend.innerHTML = 'Sending...';
      resend.style.pointerEvents = 'none';

      try {
        const email = document.getElementById('email').value.trim();
        const response = await fetch('/profile/resendOTP', {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email })
        });

        const data = await response.json();

        if (data.success) {
          resend.innerHTML = 'Resend';
          startTimer(50);
        } else {
          alert(data.message || "Something went wrong");
          resend.innerHTML = 'Resend';
          resend.style.pointerEvents = 'auto';
        }
      } catch (err) {
        console.error(err);
        resend.innerHTML = 'Resend';
        resend.style.pointerEvents = 'auto';
      }
    });

    // --- Fade-out success message ---
    if (successOTP && successOTP.textContent.trim() !== '') {
      setTimeout(() => {
        successOTP.classList.add('fade-out');
        successOTP.addEventListener('transitionend', () => successOTP.remove());
      }, 3000);
    }

    // --- Auto Start Timer on Page Load ---
    console.log('page loaded, starting timer');
    startTimer(50);
  });
</script>
 </body>
</html>
