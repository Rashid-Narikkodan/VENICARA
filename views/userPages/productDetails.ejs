<%- include("../partials/user/header.ejs") %>
  <style>
    .thumb {
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    .thumb:hover {
      transform: scale(1.1);
    }

    .small-container {
      position: relative;
    }

    #lens {
      position: absolute;
      width: 150px;
      height: 100px;
      background: rgba(0, 0, 0, 0.2);
      pointer-events: none;
      display: none;
    }

    .zoom-container {
      position: absolute;
      top: 10%;
      right: 0;
      border: 1px solid #ccc;
      background-repeat: no-repeat;
      margin-left: 20px;
      backdrop-filter: blur(5px); 
    }

    .breadcrumb-item+.breadcrumb-item::before {
      content: ">";
      font-weight: bolder;
      color: #6c757d;
      padding: 0 .5rem;
    }

    .relatedProducts {
      transition: transform .3s ease;
    }

    .relatedProducts:hover {
      transform: scale(1.1);
    }
    .related-scroll {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch; /* smooth on iOS */
}

.related-scroll::-webkit-scrollbar {
  display: none; /* hide scrollbar on mobile */
}
    #imageZoom{
      width:60%
    }
  
    

     @media (min-width: 768px) { /* md breakpoint */
    .d-flex.flex-column a.btn {
      width: 50% !important;
    }
 
  }
  @media (max-width:576px){
    #imageZoom{
      width:100%
    }
  }
  </style>
  <main class="flex-grow-1 bg-light w-100">

    <div class="container-fluid">
      <div class="row">
        <div class="col-md-7 text-center p-4">
          <div class="row">
            <div id="imageZoom" class="col-12 p-4 mx-md-auto small-container">
              <img id="mainImg" src="<%= product.images[0].url%>" class="img-fluid rounded-4 shadow" alt="Product Image" />
              <div id="lens"></div>
            </div>
            <div style="right:2rem;width:50%;height:40rem"
              class="zoom-container d-none z-3 rounded-5 border-secondary" id="zoomBox"></div>
            <div class="col-md-12">
              <div class="row justify-content-center">
                <%product.images.forEach((image)=>{%>
                  <div class="col-md-3 col-4">
                    <img src="<%=image.url%>" class="img-fluid rounded-4 thumb shadow" alt="<%=product.name%>">
                  </div>
                  <%})%>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-5 p-5">
          <nav aria-label="breadcrumb" class="d-md-block d-none">
            <ol class="breadcrumb">
              <li class="breadcrumb-item"><a href="/home" class="text-decoration-none text-muted">Home</a></li>
              <li class="breadcrumb-item"><a href="/shop" class="text-decoration-none text-muted">Shop</a></li>
              <% if(product.category) { %>
                <li class="breadcrumb-item">
                  <a class="text-decoration-none text-muted" href="/shop?category=<%= product.category._id %>">
                    <%= product.category.name %>
                  </a>
                </li>
                <% } %>
                  <% if(product) { %>
                    <li class="breadcrumb-item active" aria-current="page">
                      <%= product.name %>
                    </li>
                    <% } %>
            </ol>
          </nav>
          <!-- Product Name -->
          <h3 class="text-uppercase">
            <%= product.name%>
          </h3>
          <p class="fs-5 text-muted ">A fragrance crafted for <%=product.category.name%>
          </p>
          <div id="variantDetails" class="mt-3">
            <div class="d-flex align-items-center mb-3">
              <span class="rounded-5 me-2 text-white bg-success px-3 py-1 fw-bold d-flex align-items-center">
                &#x2606; <%=averageRating||'No Rating'%>
              </span>
              <span class="text-muted fw-semibold fs-5">
                (<%=reviews.length%>)
              </span>
            </div>
            <div>
              <span id="variantPrice" class="fw-bold fs-4">RS. <%= Math.min(...product.variants.map(v=>v.finalAmount))%></span>
              <span id="variantBasePrice" class="ms-2 me-2 fw-semibold fs-5 text-muted text-decoration-line-through">₹
                <%=Math.min(...product.variants.map(v=>v.basePrice))%>
              </span>
              <span id="variantPerc" class="rounded text-success fw-bold p-1">
            <%= product.variants.reduce((min, v) => {
           return  parseInt(v.volume) < parseInt(min.volume) ? v : min}, product.variants[0]).finalDiscount %>% off
          </span>
            </div>
            <div>
              <span id="variantStock" class="text-danger fs-4 fw-bold">
                <%=!product.isAvailable?'Product not Available': product.variants.reduce((min, v)=>
                 v.finalAmount < min.finalAmount ? v : min).stock <= 0 ? 'Out of Stock':''%>
              </span>
            </div>
          </div>

          <%const lowestVariant = product.variants.reduce((min, v) => v.finalAmount < min.finalAmount ? v : min, product.variants[0])%>

          <div class="d-flex flex-column mt-3 gap-2 align-items-start">
            <button class="btn btn-dark rounded-5 w-50 fw-bold" 
                onclick="addToWishlist(this,'/wishlist/api/add/<%=product._id%>')" 
                data-variant-id="<%= lowestVariant._id %>" 
                data-source="details" 
                style="padding:1rem 2rem"
                id="addToWishlist">
              <span>ADD TO WISHLIST</span>
            </button>
            <button onclick="addToCart(this,'/cart/addToCart/<%=product._id%>')" 
                data-variant-id="<%= lowestVariant._id %>" 
                class="btn btn-dark rounded-5 w-50 fw-bold" 
                style="padding:1rem 3rem"
                id="addToCart">
              <span>ADD TO CART</span>
            </button>
          </div>

          <!-- Variant buttons -->
          <div class="mt-4">
            <% product.variants.sort((a,b)=>a.finalAmount-b.finalAmount).forEach((variant, index)=> { %>
              <button class="btn btn-outline-dark rounded-5 variant-btn <%= index === 0 ? 'active' : '' %>"
                data-price="<%= variant.finalAmount%>" data-volume="<%= variant.volume %>"
                data-basePrice="<%= variant.basePrice%>" data-discount="<%= variant.finalDiscount %>"
                data-stock="<%=variant.stock%>" data-isAvailable="<%=product.isAvailable%>"
                data-id="<%=variant._id%>">
                <%= variant.volume %>ML
              </button>
              <% }) %>
          </div>

          <!-- description and reviews -->
          <div>
            <p class="mb-1 mt-4 fs-5">
              <span onclick="callDescription()" class="text-black fw-semibold product-tab"
                data-description="<%=product.description%>" data-tags="<%=product.tags%>">
                Descriptipn
              </span>
              <span onclick="callReviews()" class="ms-3 product-tab">
                Reviews
              </span>
            </p>
            <hr class="mt-0">
            <div id="content">
              <p style="font-size: large;" id="productDescription">
                <%=product.description%>
              </p>
              <p class="mt-2" id="productTags">
                <span class="fw-bold ">Highlights </span>:
              <ul>
                <% product.tags.forEach(t=> { %>
                  <li style="font-size: large;">
                    <%=t.charAt(0).toUpperCase()+t.slice(1)%>
                  </li>
                  <% }) %>
              </ul>
              </p>
            </div>
          </div>
        </div>
        <hr>
<div class="col-md-12">
  <h3 class="p-5 ms-5">YOU MAY ALSO LIKE</h3>

  <!-- Scrollable container -->
  <div class="related-scroll px-3 pb-5">
    <div class="d-flex flex-row flex-nowrap">
      <% relatedProducts.forEach(product => { %>
        <div class="relatedProducts me-3" style="flex: 0 0 auto; width: 220px;">
          <a href="/products/<%=product._id%>" 
             class="card text-decoration-none p-3 rounded-4 border-0 shadow"
             style="background:white">
            <img src="<%=product.images[0]?.url%>" class="card-img-top rounded-4" alt="Product Image">
            <div class="card-body p-0 pt-3">
              <h6 class="card-title mb-1"><%=product.name%></h6>
              <p class="text-muted mb-2" style="font-size:0.85rem;">
                Category: <%=product.category.name%>
              </p>
              <p class="mb-0 justify-content-between d-flex align-items-center">
                <span>
                  <span class="text-success fw-bold">
                    ₹<%=Math.min(...product.variants.map(v => v.finalAmount))%>
                  </span>
                  <span class="text-muted text-decoration-line-through">
                    ₹<%=Math.min(...product.variants.map(v => v.basePrice))%>
                  </span>
                  <span class="text-success fw-bold">
                    <%= product.variants.reduce((min, v) => {
                         return parseInt(v.volume) < parseInt(min.volume) ? v : min;
                       }, product.variants[0]).finalDiscount %>% off
                  </span>
                </span>
              </p>
            </div>
          </a>
        </div>
      <% }) %>
    </div>
  </div>
</div>
      </div>
  </main>
  <script>
    // image like gallary
    const mainImg = document.getElementById('mainImg');
    const thumbs = document.getElementsByClassName('thumb');
    for (let i = 0; i < thumbs.length; i++) {
      thumbs[i].addEventListener('click', function () {
        mainImg.src = this.src;
      })
    }

  function initVariantSelection() {
  const variantButtons = document.querySelectorAll(".variant-btn");
  const variantPrice = document.getElementById("variantPrice");
  const variantBasePrice = document.getElementById("variantBasePrice");
  const variantPerc = document.getElementById("variantPerc");
  const variantStock = document.getElementById("variantStock");
  const variantId = document.getElementById("variantId");
  const addToWishlist = document.getElementById("addToWishlist");
  const addToCart = document.getElementById("addToCart");

  if (!variantButtons.length) return;

  variantButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      // 1. Remove active class from all buttons
      variantButtons.forEach((b) => b.classList.remove("active"));

      // 2. Add active class to selected button
      btn.classList.add("active");

      // 3. Read variant data attributes
      const price = btn.dataset.price;
      const basePrice = btn.dataset.baseprice;
      const percentage = btn.dataset.discount;
      const stock = parseInt(btn.dataset.stock);
      const isAvailable = btn.dataset.isavailable === "true";
      const id = btn.dataset.id;

      // 4. Update UI fields (if exist)
      if (variantPrice) variantPrice.textContent = `₹${price}`;
      if (variantBasePrice) variantBasePrice.textContent = `₹${basePrice}`;
      if (variantPerc) variantPerc.textContent = `${Math.round(percentage)}% off`;

      if (variantStock) {
        if (!isAvailable) variantStock.textContent = "Product not available";
        else if (stock <= 0) variantStock.textContent = "Out of stock";
        else variantStock.textContent = "";
      }

      if (variantId) variantId.value = id;

      // 5. Update "Add to Cart" and "Wishlist" buttons with selected variant
      if (addToCart) addToCart.dataset.variantId = id;
      if (addToWishlist) addToWishlist.dataset.variantId = id;
    });
  });
}

// Initialize when DOM is ready
document.addEventListener("DOMContentLoaded", initVariantSelection);


    const productTab = document.querySelectorAll('.product-tab')
    productTab.forEach(tab => {
      tab.addEventListener("click", () => {
        productTab.forEach(t => t.classList.remove("fw-semibold", "text-black"));
        tab.classList.add("fw-semibold", "text-black");
      });
    });

    //call reviews
    async function callReviews() {
      const content = document.getElementById('content')
      content.innerHTML = `
      <div class="container my-4">
  <h4 class="fw-bold"><%= averageRating %></h4>
  <div class="text-warning fs-4">
    <% for(let i=1; i<=5; i++){ %>
      <% if(i <= Math.round(averageRating)) { %>
        &#9733;
      <% } else { %>
        &#9734;
      <% } %>
    <% } %>
  </div>
  <p>Product Rating</p>

  <div>
    <% for(let i=5; i>=1; i--){ %>
      <div class="d-flex align-items-center">
        <span class="me-2"><%= i %> ★</span>
        <div class="progress flex-grow-1 me-2">
          <div class="progress-bar bg-success" style="width:<%= ratingPercentages[i] %>%"></div>
        </div>
        <span><%= ratingPercentages[i] %>%</span>
      </div>
    <% } %>
  </div>
</div>


  <hr>

  <!-- Reviews -->
  <div class="mt-3">
    <%reviews.forEach((r)=>{%>
    <div class="d-flex mb-3">
      <div class="me-2">👤</div>
      <div>
        <strong><%=r.name%></strong>
        <div class="text-warning">
          <% for(let i = 1; i <= 5; i++) { %>
            <% if(i <= r.rating) { %>
              &#9733; <!-- filled star -->
            <% } else { %>
              &#9734; <!-- empty star -->
            <% } %>
          <% } %>
        </div>

        <p><%=r.message%></p>
        </div>
        </div>
    <%})%>
</div>
`
    }
    async function callDescription() {
      const content = document.getElementById('content')
      content.innerHTML = `
      <p style="font-size: large;" id="productDescription"><%=product.description%></p>
              <p class="mt-2" id="productTags">
                <span class="fw-bold ">Highlights </span>:
                <ul>
                  <% product.tags.forEach(t => { %>
                   <li style="font-size: large;"><%=t.charAt(0).toUpperCase()+t.slice(1)%></li>
                  <% }) %>
                </ul>
              </p>
      `
    }


    //image magnifier
    //main img already taken
    const lens = document.getElementById("lens");
    const zoomBox = document.getElementById("zoomBox");

    mainImg.addEventListener("mouseenter", () => {
      lens.style.display = "block"
      zoomBox.classList.remove('d-none')
    });
    mainImg.addEventListener("mouseleave", () => {
      lens.style.display = "none"
      zoomBox.classList.add('d-none')
    })



    mainImg.addEventListener("mousemove", function (e) {
      const rect = mainImg.getBoundingClientRect();
      let x = e.clientX - rect.left;
      let y = e.clientY - rect.top;

      // Keep lens centered on cursor
      lens.style.left = x - lens.offsetWidth / 2 + "px";
      lens.style.top = y - lens.offsetHeight / 2 + "px";

      // Show zoomed image
      zoomBox.style.backgroundImage = `url('${mainImg.src}')`;
      zoomBox.style.backgroundSize = `${mainImg.width * 3}px ${mainImg.height * 3}px`;
      zoomBox.style.backgroundPosition =
        `-${x * 3 - zoomBox.offsetWidth / 2}px -${y * 3 - zoomBox.offsetHeight / 2}px`;
    });


async function addToCart(btn, url) {
  // Prevent multiple clicks
  if (btn.disabled) return;
  btn.disabled = true;
  btn.textContent = 'Adding...'; // optional visual feedback

  try {
    const variantId = btn.getAttribute('data-variant-id');
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ variantId })
    });

    const data = await res.json();

    if (data.status) {
      showAlert('success', data.message);
      updateCartCount();
    } else {
      showAlert('error', data.message);
    }
  } catch (error) {
    console.error(error);
    showAlert('error', 'Something went wrong. Try again.');
  } finally {
    // Re-enable after all operations
    btn.disabled = false;
    btn.textContent = 'ADD TO CART'; // restore text
  }
}

    async function addToWishlist(btn,url){
        if (btn.disabled) return;
          btn.disabled = true;
          btn.textContent = 'Adding...'; // optional visual feedback
      try{
        const variantId = btn.getAttribute('data-variant-id')
        const source = btn.getAttribute('data-source')
        const res = await fetch(url,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({variantId,source})
        })
        const data = await res.json()
        if(data.status){
          showAlert('success',data.message)
        }else{
          showAlert('error',data.message)
        }
      }catch(error){
        console.log(error)
      } finally {
    // Re-enable after all operations
    btn.disabled = false;
    btn.textContent = 'ADD TO WISHLIST'; // restore text
  }
    }
  </script>
  <%- include("../partials/user/footer.ejs") %>