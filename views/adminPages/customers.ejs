<%- include('../partials/admin/header.ejs')%>
<style>
  /* Responsive User Management */
  @media (max-width: 767.98px) {
    .users-table thead {
      display: none;
    }
    .users-table tr {
      display: block;
      margin-bottom: 1.5rem;
      border: 1px solid #dee2e6;
      border-radius: 0.25rem;
      padding: 0.5rem;
      background-color: #fff;
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    .users-table td {
      display: flex;
      justify-content: space-between;
      align-items: center;
      text-align: right !important;
      border-top: 1px solid #dee2e6;
      padding: 0.75rem 1rem;
    }
    .users-table td:first-child {
      border-top: none;
    }
    .users-table td::before {
      content: attr(data-label);
      font-weight: bold;
      text-transform: uppercase;
      color: #6c757d;
      flex: 0 0 40%;
      text-align: left;
    }
    .users-table .status-btn {
      width: 100% !important;
      margin: 0 !important;
    }
  }

  /* Search Form Mobile */
  @media (max-width: 767.98px) {
    .search-form {
      flex-direction: column !important;
      width: 100% !important;
    }
    .search-form input {
      width: 100% !important;
      margin-bottom: 0.5rem !important;
    }
    .search-form button {
      width: 100% !important;
    }
  }

  /* Mobile Layout */
  @media (max-width: 575.98px) {
    .main-container {
      padding: 0.5rem !important;
    }
    h1 {
      font-size: 1.5rem !important;
      text-align: center !important;
    }
    .fs-2 {
      font-size: 1.75rem !important;
    }
    .header-row {
      flex-direction: column !important;
      gap: 1rem !important;
      text-align: center !important;
    }
  }

  /* Modal Mobile */
  @media (max-width: 575.98px) {
    .modal-dialog {
      margin: 0.5rem !important;
    }
  }
</style>

<main class="flex-grow-1 min-vh-100 p-3 main-container">
  <div class="container-fluid">
    <!-- Header with Search -->
    <div class="row align-items-center header-row mb-5">
      <div class="col-12 col-md-6">
        <h1 class="mb-3 mb-md-0">User Management</h1>
      </div>
      <div class="col-12 col-md-6">
        <form action="/admin/customers" method="GET" class="search-form d-flex justify-content-end gap-2 w-100">
          <input type="text" 
                 name="search" 
                 class="form-control" 
                 placeholder="Search by name/email..." 
                 value="<%= search %>">
          <button class="btn btn-dark">Search</button>
        </form>
      </div>
    </div>

    <!-- Users Table -->
    <div class="table-responsive shadow rounded-3 bg-white">
      <table class="table table-hover align-middle mb-0 users-table">
        <thead class="table-dark">
          <tr>
            <th class="text-center p-3">No.</th>
            <th class="text-center p-3">Customer</th>
            <th class="text-center p-3">Email</th>
            <th class="text-center p-3">Customer ID</th>
            <th class="text-center p-3">Verified</th>
            <th class="text-center p-3">Created On</th>
            <th class="text-center p-3">Status</th>
          </tr>
        </thead>
        <tbody>
          <% users.forEach(user=> { %>
            <%count++%>
            <tr>
              <td data-label="No." class="text-center"><%= count %></td>
              <td data-label="Customer"><%= user.name %></td>
              <td data-label="Email"><%= user.email %></td>
              <td data-label="Customer ID"><%= user.userId %></td>
              <td data-label="Verified">
                <span class="badge <%= user.isVerified ? 'bg-success' : 'bg-danger' %>">
                  <%= user.isVerified ? 'Verified' : 'Not verified' %>
                </span>
              </td>
              <td data-label="Created On"><%= user.createdAt.toLocaleDateString() %></td>
              <td data-label="Status">
                <button type="button" 
                        onclick="showConfirmModal('<%=user._id%>', '<%= user.isBlocked ? 'User will be Activated' : 'User will be Blocked' %>')"
                        class="status-btn alert px-3 py-1 w-100 <%= user.isBlocked ? 'alert-danger text-danger' : 'alert-success text-success' %>">
                  <%= user.isBlocked ? 'Blocked' : 'Active' %>
                </button>
              </td>
            </tr>
            <% }) %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Pagination -->
  <div class="d-flex justify-content-end mt-4">
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-end flex-wrap p-3">
        <!-- Previous Button -->
        <% if (currentPage > 1) { %>
          <li class="page-item">
            <a class="page-link bg-dark" 
               href="?page=<%= currentPage - 1 %>&limit=<%= limit %>&search=<%= search %>">
              <i class="fa-solid fa-caret-left text-white"></i>
            </a>
          </li>
        <% } else { %>
          <li class="page-item disabled">
            <span class="page-link bg-dark">
              <i class="fa-solid fa-caret-left text-white"></i>
            </span>
          </li>
        <% } %>

        <!-- Left Page -->
        <% if (currentPage - 1 >= 1) { %>
          <li class="page-item">
            <a class="page-link" 
               href="?page=<%= currentPage - 1 %>&limit=<%= limit %>&search=<%= search %>">
              <%= currentPage - 1 %>
            </a>
          </li>
        <% } %>

        <!-- Current Page -->
        <li class="page-item active">
          <span class="page-link bg-white text-dark border-0">
            <%= currentPage %>
          </span>
        </li>

        <!-- Right Page -->
        <% if (currentPage + 1 <= totalPages) { %>
          <li class="page-item">
            <a class="page-link" 
               href="?page=<%= currentPage + 1 %>&limit=<%= limit %>&search=<%= search %>">
              <%= currentPage + 1 %>
            </a>
          </li>
        <% } %>

        <!-- Next Button -->
        <% if (currentPage < totalPages) { %>
          <li class="page-item">
            <a class="page-link bg-dark" 
               href="?page=<%= currentPage + 1 %>&limit=<%= limit %>&search=<%= search %>">
              <i class="fa-solid fa-caret-right text-white"></i>
            </a>
          </li>
        <% } else { %>
          <li class="page-item disabled">
            <span class="page-link bg-dark">
              <i class="fa-solid fa-caret-right text-white"></i>
            </span>
          </li>
        <% } %>
      </ul>
    </nav>
  </div>

  <!-- Confirmation Modal -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-dark">
        <div class="modal-header bg-dark text-white">
          <h5 class="modal-title" id="confirmLabel">Are you sure?</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p id="confirmMessage" class="text-center"></p>
        </div>
        <div class="modal-footer justify-content-center">
          <button type="button" data-bs-dismiss="modal" class="btn btn-outline-dark">Cancel</button>
          <button type="button" class="btn btn-dark" id="yes" data-userId="">Confirm</button>
        </div>
      </div>
    </div>
  </div>
</main>
  </div>
<script>
  function showConfirmModal(userId, message) {
    const modalEl = document.getElementById("confirmModal");
    const messageEl = document.getElementById("confirmMessage");
    const yesBtn = document.getElementById("yes");
    
    messageEl.textContent = message;
    yesBtn.setAttribute('data-userId', userId);
    
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
  }

  document.getElementById('yes').addEventListener('click', (e) => {
    const userId = e.target.getAttribute('data-userId');
    toggleUserStatus(userId);
  });

  function toggleUserStatus(userId) {
    fetch(`/admin/customers/${userId}/toggle?_method=PATCH`, {
      method: 'PATCH'
    })
    .then(response => {
      if (response.ok) {
        location.reload();
      } else {
        showAlert("error",'Failed to update user status');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred');
    });
  }
</script>

<%- include('../partials/admin/footer.ejs')%>