<%- include('../partials/admin/header.ejs')%>
<main class="flex-grow-1 min-vh-100 p-3">
  <div class="container">
    <div class="row">
      <div class="col-md-8 p-3 rounded-4" style="background-color: rgb(192, 192, 192);">
        <div class="container">
          <div class="row">
            <p class="p-4 fw-bold fs-2">Order Details</p>
            <div class="col-md-6 p-3">
              <span class="fw-bold">OrderID : </span>
              <span><%=order.orderId%></span>
            </div>
            <div class="col-md-6 p-3">
              <span class="fw-bold">Customer : </span>
              <span class="fw-semibold"><%=order.userId?.name%></span>
            </div>
            <div class="col-md-6 p-3">
              <span class="fw-bold">Ordered On : </span>
              <span class="fw-semibold"><%=order.createdAt.toLocaleDateString()%></span>
            </div>
            <div class="col-md-6 p-3">
              <span class="fw-bold">Updated On : </span>
              <span class="fw-semibold"><%=order.updatedAt.toLocaleDateString()%></span>
            </div>
            <div class="col-md-6 p-3">
              <span class="fw-bold">Payment method : </span>
              <span class="fw-semibold"><%=order.payment.method%></span>
            </div>
            <div class="col-md-6 p-3">
              <span class="fw-bold">Payment status : </span>
              <span class="fw-semibold"><%=order.payment.status%></span>
            </div>
            <div class="col-md-6 p-3">
              <span class="fw-bold">Coupon : </span>
              <span class="fw-semibold"><%=order.couponApplied?.code || 'Not Applied'%></span>
            </div>
            <div class="col-md-6 p-3">
              <span class="fw-bold">Total Amount : </span>
              <span class="fw-semibold">₹<%=order.finalAmount%></span>
            </div>
            <hr />
            <div class="col-md-6 p-3 p-2">
              <form action="/admin/orders/<%= order._id %>/status?_method=PATCH" method="POST" class="d-inline order-status-form">
                <select name="status" data-status ="<%=order.status%>" class="form-select form-select-sm d-inline w-auto status-select">
                    <option value="confirmed" <%= order.status === "pending"||order.status === "confirmed" ? "selected" : "" %>>Confirmed</option>                    
                    <option value="shipped" <%= order.status === "shipped" ? "selected" : "" %>>Shipped</option>
                    <option value="Out of delivery" <%= order.status === "Out of delivery" ? "selected" : "" %>>Out of Delivery</option>
                    <option value="delivered" <%= order.status === "delivered" ? "selected" : "" %>>Delivered</option>
                    <option value="cancelled" <%= order.status === "cancelled" ? "selected" : "" %>>Cancelled</option>
                    <option value="returned" <%= order.status === "returned" ? "selected" : "" %>>Returned</option>
                </select>
                <button type="submit" class="btn btn-sm btn-primary ms-1 update-btn">Update</button>
                </form>

            </div>
            <div class="col-md-6 p-3 p-2">
              <span class="fw-bold">Status : </span>
              <span class="text-success fw-semibold"><%=order.status%></span>
            </div>
              <div class="col-md-12 px-3 mb-3 alert alert-primary text-primary d-flex justify-content-between align-items-center <%=!order.return.isRequested?'d-none':''%>">
                <div>
                <p class="fw-bold">New Request : <span class="fw-semibold text-dark">Customer Requested to Return Order</span></p>
                <span class="fw-bold">Reason : </span>
                <span class="fw-semibold text-dark"><%=order.return.reason%></span>
                </div>
                <div>
                  <button onclick="Approve('<%= order._id %>')" class="btn btn-sm btn-primary" >Approve</button>
                  <button class="btn btn-sm btn-dark" onclick="openRejectModal('<%= order._id %>')">Reject</button>

                </div>
              </div>
              <div class="<%=!order.return?.adminReason?'d-none':''%> text-danger p-3">
                Return Rejected Reason : <span class="fw-semibold text-dark"><%=order.return.adminReason%></span>
              </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="d-flex flex-column gap-3">
          <div style="background:rgb(192, 192, 192)" class="p-4 rounded-4 shadow-sm mb-3">
  <p class="fw-bold fs-5 mb-2">Shipping Address</p>
  <p class="mb-1"><strong>Name:</strong> <%=order.shippingAddress.fullName%></p>
  <p class="mb-1"><strong>Street:</strong> <%=order.shippingAddress.street%></p>
  <p class="mb-1"><strong>City:</strong> <%=order.shippingAddress.city%></p>
  <p class="mb-1"><strong>State:</strong> <%=order.shippingAddress.state%></p>
  <p class="mb-1"><strong>Pincode:</strong> <%=order.shippingAddress.pin%></p>
  <p class="mb-0"><strong>Phone:</strong><%=order.shippingAddress.mobile%></p>
</div>

          <div class="p-4 rounded-4" style="background:rgb(192, 192, 192)">
            <p class="fw-bold fs-5 mb-2">Billing Summary</p>
            <div class="d-flex justify-content-between">
              <span>Subtotal:</span>
              <span>₹<%=order.totalOrderPrice%></span>
            </div>
            <div class="d-flex justify-content-between">
              <span>Coupon Discount:</span>
              <span class="text-success"><%=order.couponDiscount?order.couponDiscount+'%':'No Coupon'%></span>
            </div>
            <%if(order.deliveryCharge){%>
              <div class="d-flex justify-content-between">
                  <span>Delivery Charge:</span>
                  <span class="text-success">
                    ₹<%=parseFloat(order.deliveryCharge.toFixed(2))%>
                  </span>
                </div>
              <div class="d-flex justify-content-between">
                  <span>Total:</span>
                  <span class="text-dark fw-semibold">
                    ₹<%=parseFloat((order.deliveryCharge+order.totalOrderPrice).toFixed(2))%>
                  </span>
                </div>

                <div class="d-flex justify-content-between">
                  <span>Discount Amount:</span>
                  <span class="text-danger">
                    - ₹<%=parseFloat(((order.totalOrderPrice+order.deliveryCharge)-order.finalAmount).toFixed(2))%>
                  </span>
                </div>
              <%}else{%>
                <div class="d-flex justify-content-between">
                  <span>Discount Amount:</span>
                  <span class="text-danger">
                    - ₹<%=parseFloat((order.totalOrderPrice-order.finalAmount).toFixed(2))%>
                  </span>
                </div>
                  <%}%>
            
            <hr />
            <div class="d-flex justify-content-between fw-bold">
              <span>Total Amount:</span>
              <span>₹<%=order.finalAmount%></span>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-12 rounded-4">
        <p class="p-4 fw-bold fs-2">Products</p>
        <table class="table table-hover align-middle mb-0">
            <thead class="table-dark">
              <tr>
                <th class="text-center p-3">No.</th>
                <th class="text-center p-3">Product</th>
                <th class="text-center p-3">Qty</th>
                <th class="text-center p-3">Update</th>
                <th class="text-center p-3">Status</th>
                <th class="text-center p-3">Return</th>
                <th class="text-center p-3">Return reason</th>
                <th class="text-center p-3">Return Action</th>
              </tr>
            </thead>
            <tbody>
              <% order.products.forEach((product,index)=> { %>
                <%count++%>
                  <tr>
                    <td class="text-center">
                      <%= count %>
                    </td>
                    <td class="text-center">
                      <%= product.productName %>
                    </td>
                    <td class="text-center">
                        <%= product.quantity%>
                    </td>
                    <td class="text-center">
                         <form action="/admin/orders/product/status/<%=order._id%>?_method=PATCH&index=<%=index%>" method="POST" class="d-inline order-status-form">
                <select name="status" data-status="<%=product.status%>" class="form-select form-select-sm d-inline w-auto status-select">
                    <option value="confirmed" <%= product.status === "pending"||product.status === "confirmed" ? "selected" : "" %>>Confirmed</option>
                    <option value="shipped" <%= product.status === "shipped" ? "selected" : "" %>>Shipped</option>
                    <option value="Out of delivery" <%= product.status === "Out of delivery" ? "selected" : "" %>>Out of Delivery</option>
                    <option value="delivered" <%= product.status === "delivered" ? "selected" : "" %>>Delivered</option>
                    <option value="cancelled" <%= product.status === "cancelled" ? "selected" : "" %>>Cancelled</option>
                    <option value="returned" <%= product.status === "returned" ? "selected" : "" %>>Returned</option>
                </select>
                <button type="submit" class="btn btn-sm btn-primary ms-1 update-btn">Update</button>
                </form>

                    </td>
                    <td class="text-center text-success">
                      <%=product.status%>
                  </td>
                  <td class="text-center">
                    <span class="badge <%=product.return.isRequested?'bg-primary':product.status == "returned"?'bg-success':'bg-secondary'%>"><%=product.return.isRequested?'Requested':product.status == "returned"?'Approved':'No request'%></span>
                  </td>
                  <td class="text-center text-black">
                    <%=product?.return.reason||'-'%>
                </td>
                <td class="text-center">
                    <% if(product.return.isRequested && !product.return.adminReason){ %>
                  <button onclick="Approve('<%= order._id %>', '<%= index %>')" class="btn btn-sm btn-primary" >Approve</button>
                  <button class="btn btn-sm btn-dark" onclick="openRejectModal('<%= order._id %>', '<%= index %>')">Reject</button>
                  <% }else{ %>
                    <span>-</span>
                  <% } %>
                </td>
                  </tr>
                  <% }) %>
            </tbody>
          </table>
      </div>

    </div>
  </div>
  <!-- Reject Reason Modal -->
<div class="modal fade" id="rejectReturnModal" tabindex="-1" aria-labelledby="rejectReturnLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="rejectReturnForm" method="POST">
        <div class="modal-header">
          <h5 class="modal-title" id="rejectReturnLabel">Reject Return Request</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="mb-3">
            <label for="rejectReason" class="form-label fw-semibold">Reason for Rejection</label>
            <textarea name="rejectReason" id="rejectReason" class="form-control" rows="3" placeholder="Enter reason for rejecting this return request" required></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-danger">Reject</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

</main>
</div>
<script>
   function openRejectModal(orderId, index = null) {
    let url = index !== null
      ? `/admin/orders/${orderId}/return/reject?_method=PATCH&index=${index}`
      : `/admin/orders/${orderId}/return/reject?_method=PATCH`;

    document.getElementById("rejectReturnForm").action = url;

    const modal = new bootstrap.Modal(document.getElementById("rejectReturnModal"));
    modal.show();
  }

  function Approve(orderId, index = null) {
    let url = index !== null
      ? `/admin/orders/${orderId}/return/approve?index=${index}`
      : `/admin/orders/${orderId}/return/approve`;

    fetch(url, {
      method: 'PATCH'
    })
    .then(response => {
      if (response.ok) {
        location.reload(); // Reload the page to reflect changes
      } else {
        showAlert('error','Failed to approve return request.');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showAlert('error','An error occurred while processing the request.');
    });
  }

  document.querySelectorAll('.order-status-form').forEach(form => {
    const select = form.querySelector('.status-select');
    const button = form.querySelector('.update-btn');
    let currentStatus = select.getAttribute('data-status'); // from DB
    console.log(currentStatus)
    if(currentStatus == 'Out of delivery') currentStatus = 'out_of_delivery'

    // Define allowed transitions
    const transitions = {
      pending: ["confirmed"],
      confirmed:["shipped", "Out of delivery","cancelled"],
      shipped: ["Out of delivery", "delivered"],
      out_of_delivery: ["delivered"],
      delivered: ['returned'],   // final
      cancelled: [],   // final
      returned: []     // final
    };

    function lockOptions() {
      const allowed = transitions[currentStatus] || [];
      // Disable everything by default
      [...select.options].forEach(opt => {
        opt.disabled = true;
      });

      // Keep current status selectable (to show properly)
      [...select.options].forEach(opt => {
        if (opt.value === currentStatus) {
          opt.disabled = false;
        }
      });

      // Enable only forward statuses
      [...select.options].forEach(opt => {
        if (allowed.includes(opt.value)) {
          opt.disabled = false;
        }
      });

      // Disable button if no valid moves left
      button.disabled = allowed.length === 0;
    }

    lockOptions(); // Run on page load
  });

</script>

<%- include('../partials/admin/footer.ejs')%>
