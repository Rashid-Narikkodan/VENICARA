<%- include('../partials/admin/header.ejs') %>
<style>
  .card {
    border-radius: 12px;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
  }
  .card h4 {
    font-weight: 700;
    letter-spacing: 0.5px;
  }
  .table thead th {
    color: #fff;
    border: none;
    text-transform: uppercase;
    font-size: 0.85rem;
    letter-spacing: 0.5px;
    text-align: center;
    padding: 1rem !important;
  }
  .table tbody tr:hover {
    background-color: #e9f5ff;
    transition: background-color 0.2s;
  }
  .table td, .table th {
    vertical-align: middle;
    text-align: center;
  }
  #durationFilter option {
    padding: 10px 14px;
    font-weight: 400;
    color: #374151;
    background: #fff;
    border: none;
  }
  .text-success { color: #198754 !important; }
  .text-danger { color: #dc3545 !important; }
  .text-warning { color: #ffc107 !important; }
  .text-primary { color: #0d6efd !important; }
  .text-info { color: #0dcaf0 !important; }
  /* Responsive adjustments */
  @media (max-width: 768px) {
    main {
      max-width: 100% !important;
      padding: 1.5rem !important;
    }
    .container-fluid {
      padding: 0 10px;
    }
    .card h4 {
      font-size: 1.2rem;
    }
    .card {
      padding: 0.75rem !important;
    }
    .form-select, .form-control {
      font-size: 0.9rem;
    }
    .d-flex.flex-wrap {
      flex-direction: column;
      align-items: stretch !important;
    }
    .w-auto {
      width: 100% !important;
    }
    .btn {
      width: 100%;
      margin-bottom: 0.5rem;
    }
    .text-md-end {
      justify-content: center !important;
    }
  }
  @media (max-width: 576px) {
    h2 {
      font-size: 1.5rem;
    }
    .text-muted {
      font-size: 0.9rem;
    }
    .form-label {
      font-size: 0.85rem;
    }
    .table {
      font-size: 0.8rem;
    }
    .table thead th {
      font-size: 0.75rem;
      padding: 0.5rem !important;
    }
    .table td {
      padding: 0.5rem !important;
    }
  }
</style>
<main class="flex-grow-1 min-vh-100 p-3" style="max-width: 80%; margin: 0 auto;">
  <div class="container-fluid">
    <div class="mb-3 text-center">
      <h2 class="fw-bold">Sales Report</h2>
      <p class="text-muted">View detailed sales statistics and export reports.</p>
    </div>
    <div class="row align-items-center mb-4 g-3">
      <div class="col-lg-8 col-md-7 col-12">
        <form id="formDate" action="/admin/salesReport" method="GET">
          <div class="d-flex flex-wrap gap-2 align-items-center w-100 ">
            <label for="durationFilter" class="form-label fw-semibold me-2 mb-0">Filter:</label>
            <select class="form-select w-auto" id="durationFilter" name="filter">
              <option value="daily" <%= filter === 'daily' ? 'selected' : '' %>>Today</option>
              <option value="weekly" <%= filter === 'weekly' ? 'selected' : '' %>>This Week</option>
              <option value="monthly" <%= filter === 'monthly' ? 'selected' : '' %>>This Month</option>
              <option value="yearly" <%= filter === 'yearly' ? 'selected' : '' %>>This Year</option>
              <option value="custom" <%= filter === 'custom' ? 'selected' : '' %>>Custom</option>
            </select>
            <div id="customDateRange" class="<%= filter === 'custom' ? '' : 'd-none' %> ms-3">
              <input name="startDate" type="date" class="form-control d-md-inline-block  w-auto" max="<%= today %>" value="<%= startDate || '' %>">
              <span class="mx-2 fw-semibold">to</span>
              <input name="endDate" type="date" class="form-control d-md-inline-block w-auto" max="<%= today %>" value="<%= endDate || '' %>">
            </div>
            <div>
              <button type="submit" id="formBtn" class="btn btn-dark">Apply</button>
            </div>
            <div>
              <a href="/admin/salesReport" class="btn btn-outline-dark">Cancel</a>
            </div>
          </div>
        </form>
      </div>
      <div class="col-lg-4 col-md-5 col-12 text-md-end d-flex justify-content-md-end gap-2">
        <form action="/admin/salesReport/export/excel" method="POST">
          <button type="submit" class="btn btn-outline-dark w-auto">
            <i class="bi bi-file-earmark-excel"></i> Export Excel
          </button>
        </form>
        <form action="/admin/salesReport/export/pdf" method="POST">
          <button type="submit" class="btn btn-dark w-auto">
            <i class="bi bi-file-earmark-pdf"></i> Export PDF
          </button>
        </form>
      </div>
      <div class="text-danger text-center" id="dateError"></div>
    </div>
    <div class="row g-3 mb-4">
      <div class="col-md-3 col-sm-4 col-6">
        <div class="card shadow-sm text-center p-3">
          <h6 class="text-muted mb-2">Total Orders</h6>
          <h4 class="fw-bold"><%= data.totalOrders %></h4>
        </div>
      </div>
      <div class="col-md-3 col-sm-4 col-6">
        <div class="card shadow-sm text-center p-3">
          <h6 class="text-muted mb-2">Products Sold</h6>
          <h4 class="fw-bold"><%= data.totalProductSold %></h4>
        </div>
      </div>
      <div class="col-md-3 col-sm-4 col-6">
        <div class="card shadow-sm text-center p-3">
          <h6 class="text-muted mb-2">Customers</h6>
          <h4 class="fw-bold"><%= data.totalCustomers %></h4>
        </div>
      </div>
      <div class="col-md-3 col-sm-4 col-6">
        <div class="card shadow-sm text-center p-3">
          <h6 class="text-muted mb-2">Cancelled Orders</h6>
          <h4 class="fw-bold text-danger"><%= data.totalCancelled %></h4>
        </div>
      </div>
      <div class="col-md-3 col-sm-4 col-6">
        <div class="card shadow-sm text-center p-3">
          <h6 class="text-muted mb-2">Returned Orders</h6>
          <h4 class="fw-bold text-warning"><%= data.totalReturned %></h4>
        </div>
      </div>
      <div class="col-md-3 col-sm-4 col-6">
        <div class="card shadow-sm text-center p-3">
          <h6 class="text-muted mb-2">Cancelled (Product)</h6>
          <h4 class="fw-bold text-primary"><%= data.totalProductCancelled %></h4>
        </div>
      </div>
      <div class="col-md-3 col-sm-4 col-6">
        <div class="card shadow-sm text-center p-3">
          <h6 class="text-muted mb-2">Returned (Products)</h6>
          <h4 class="fw-bold text-primary"><%= data.totalProductReturned %></h4>
        </div>
      </div>
      <div class="col-md-3 col-sm-4 col-6">
        <div class="card shadow-sm text-center p-3">
          <h6 class="text-muted mb-2">Discounts (Product)</h6>
          <h4 class="fw-bold text-primary">₹<%= data.totalDiscountPerProduct.toFixed(2) %></h4>
        </div>
      </div>
      <div class="col-md-3 col-sm-4 col-6">
        <div class="card shadow-sm text-center p-3">
          <h6 class="text-muted mb-2">Discounts (Order)</h6>
          <h4 class="fw-bold text-primary">₹<%= data.totalDiscountPerOrder.toFixed(2) %></h4>
        </div>
      </div>
      <div class="col-md-3 col-sm-4 col-6">
        <div class="card shadow-sm text-center p-3">
          <h6 class="text-muted mb-2">Total Revenue</h6>
          <h4 class="fw-bold text-success">₹<%= data.totalRevenue.toFixed(2) %></h4>
        </div>
      </div>
      <div class="col-md-3 col-sm-4 col-6">
        <div class="card shadow-sm text-center p-3">
          <h6 class="text-muted mb-2">Total Refunds</h6>
          <h4 class="fw-bold text-danger">₹<%= data.totalRefund.toFixed(2) %></h4>
        </div>
      </div>
      <div class="col-md-3 col-sm-4 col-6">
        <div class="card shadow-sm text-center p-3">
          <h6 class="text-muted mb-2">AOV</h6>
          <h4 class="fw-bold text-info">₹<%= data.AverageOrderValue.toFixed(2) %></h4>
        </div>
      </div>
    </div>
    <div class="table-responsive mt-5 shadow-sm rounded">
      <table class="table table-bordered table-striped align-middle mb-0">
        <thead class="table-dark">
          <tr>
            <th>Order ID</th>
            <th>Date</th>
            <th>Customer</th>
            <th>Products</th>
            <th>Payment</th>
            <th>Status</th>
            <th>Subtotal</th>
            <th>Discount</th>
            <th>Coupon Off</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          <% orders.forEach(order => { %>
            <tr>
              <td><%= order.orderId %></td>
              <td><%= order.createdAt.toLocaleDateString("en-US", {day: "2-digit",month: "short",year: "numeric"}) %></td>
              <td><%= order.userId?.name %></td>
              <td><%= order.products.reduce((s,p)=>s+p.quantity,0) %></td>
              <td><%= order.payment.method %></td>
              <td class="<%= order.status === 'delivered' ? 'text-success' : (order.status === 'cancelled' ? 'text-danger' : 'text-warning') %>">
                <%= order.status.charAt(0).toUpperCase()+order.status.slice(1) %>
              </td>
              <td>₹<%= order.products.reduce((s,p)=>s+p.basePrice*p.quantity,0) %> <%=order.deliveryCharge?`+${order.deliveryCharge}`:''%></td>
              <td>₹<%= order.productDiscount.toFixed(2) %></td>
              <td><%=order.couponDiscount? ((order.totalOrderPrice*order.couponDiscount)/100).toFixed(2):'No Coupon'%></td>
              <td>₹<%= order.finalAmount.toFixed(2) %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>
</main>
  </div>
<script>
  document.getElementById('durationFilter').addEventListener('change', function () {
    const customRange = document.getElementById('customDateRange');
    if (this.value === 'custom') {
      customRange.classList.remove('d-none');
    } else {
      customRange.classList.add('d-none');
    }
  });
  const customDateRange = document.getElementById('customDateRange');
  const startDateInput = customDateRange.querySelector('input[name="startDate"]');
  const endDateInput = customDateRange.querySelector('input[name="endDate"]');
  const dateErrorDiv = document.getElementById('dateError');
  const btn = document.getElementById('formBtn');
  customDateRange.addEventListener('change', function () {
    btn.disabled = false;
    dateErrorDiv.textContent = '';
    const startDate = new Date(startDateInput.value);
    const endDate = new Date(endDateInput.value);
    if (startDateInput.value && endDateInput.value && startDate > endDate) {
      dateErrorDiv.textContent = 'Invalid range — start date cannot be later than end date. You can\’t apply this filter.';
      endDateInput.value = '';
      btn.disabled = true;
    }
  });
</script>
<%- include('../partials/admin/footer.ejs') %>