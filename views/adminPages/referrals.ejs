<%- include('../partials/admin/header.ejs')%>

<main class="flex-grow-1 min-vh-100 p-3">
  <div class="container">
    <div class="p-4">
      <h3>Referrals</h3>
    </div>
    <div class="row g-3 mb-4">
      
      <!-- Total Referrals Card -->
      <div class="col-12 col-sm-6 col-md-3">
        <div class="card h-100 shadow-sm border-0">
          <div class="card-body text-center">
            <i class="fa-solid fa-users fs-5 text-primary mb-3"></i>
            <p class="card-text fs-4 fw-bold text-primary mb-0"><%= data.referredCount || 0 %></p>
            <p class="card-title fw-semibold text-dark mb-2">Total Referrals</p>
          </div>
        </div>
      </div>

      <!-- Referred Users Card -->
      <div class="col-12 col-sm-6 col-md-3">
        <div class="card h-100 shadow-sm border-0">
          <div class="card-body text-center">
            <i class="fa-solid fa-user-plus fs-5 text-info mb-3"></i>
            <p class="card-text fs-4 fw-bold text-info mb-0"><%= data.referrerCount || 0 %></p>
            <p class="card-title fw-semibold text-dark mb-2">Referred Users</p>
          </div>
        </div>
      </div>

      <!-- Total Rewards Paid Card -->
      <div class="col-12 col-sm-6 col-md-3">
        <div class="card h-100 shadow-sm border-0">
          <div class="card-body text-center">
            <i class="fa-solid fa-dollar-sign fs-5 text-success mb-3"></i>
            <p class="card-text fs-4 fw-bold text-success mb-0"><%= data.totalPaid %></p>
            <p class="card-title fw-semibold text-dark mb-2">Total Rewards Paid</p>
          </div>
        </div>
      </div>
      <!-- Pending Rewards Card -->
      <div class="col-12 col-sm-6 col-md-3">
        <div class="card h-100 shadow-sm border-0">
          <div class="card-body text-center">
            <i class="fa-solid fa-clock fs-5 text-warning mb-3"></i>
            <p class="card-text fs-4 fw-bold text-warning mb-0"><%= data.totalPending %></p>
            <p class="card-title fw-semibold text-dark mb-2">Pending Rewards</p>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-12">
        <div class="table-responsive shadow rounded bg-white">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-dark">
              <tr>
                <th class="text-center p-3">No.</th>
                <th class="text-center p-3">Referrer Name</th>
                <th class="text-center p-3">Referral Code</th>
                <th class="text-center p-3">Referred Users</th>
                <th class="text-center p-3">Reward Status</th>
                <th class="text-center p-3">Reward Amount</th>
                <th class="text-center p-3">Action</th>
              </tr>
            </thead>
            <tbody>
              <% let count = 0; referrals.forEach(referral => { %>
                <% count++; %>
                <tr>
                  <td class="text-center"><%= count %></td>
                  <td class="text-center"><%= referral.referrer || 'N/A' %></td>
                  <td class="text-center"><%= referral.referralCodeUsed || 'N/A' %></td>
                  <td class="text-center"><%= referral.referred || 0 %></td>
                  <td class="text-center <%= referral.status === 'pending' ? 'text-primary' : 'text-success' %>"><%= referral.status || 'N/A' %></td>
                  <td class="text-center"><%= referral.amount || 0 %></td>
                  <td class="text-center">
                    <button onclick="approveReward(this)" data-id="<%= referral._id %>" class="btn btn-sm btn-outline-primary <%= referral.status === 'claimed' ? 'disabled' : '' %>">
                      <%= referral.status === 'claimed' ? 'Claimed' : (referral.status === 'pending' ? 'Approve' : 'Approved') %>
                    </button>
                  </td>
                </tr>
              <% }); %>
              <% if (referrals.length === 0) { %>
                <tr>
                  <td colspan="7" class="text-center p-4">No referrals found.</td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <% if (totalPages > 0) { %>
      <div class="d-flex justify-content-end mt-4">
        <nav aria-label="Page navigation">
          <ul class="pagination justify-content-end flex-wrap p-3">
            <!-- Previous Button -->
            <% if (currentPage > 1) { %>
              <li class="page-item">
                <a class="page-link bg-dark" href="?page=<%= currentPage - 1 %>&limit=<%= limit %>">
                  <i class="fa-solid fa-caret-left text-white"></i>
                </a>
              </li>
            <% } else { %>
              <li class="page-item disabled">
                <span class="page-link bg-dark">
                  <i class="fa-solid fa-caret-left text-white"></i>
                </span>
              </li>
            <% } %>

            <!-- Left Page (if exists) -->
            <% if (currentPage - 1 >= 1) { %>
              <li class="page-item">
                <a class="page-link" href="?page=<%= currentPage - 1 %>&limit=<%= limit %>">
                  <%= currentPage - 1 %>
                </a>
              </li>
            <% } %>

            <!-- Current Page -->
            <li class="page-item active">
              <span class="page-link bg-primary text-white border-0">
                <%= currentPage %>
              </span>
            </li>

            <!-- Right Page (if exists) -->
            <% if (currentPage + 1 <= totalPages) { %>
              <li class="page-item">
                <a class="page-link" href="?page=<%= currentPage + 1 %>&limit=<%= limit %>">
                  <%= currentPage + 1 %>
                </a>
              </li>
            <% } %>

            <!-- Next Button -->
            <% if (currentPage < totalPages) { %>
              <li class="page-item">
                <a class="page-link bg-dark" href="?page=<%= currentPage + 1 %>&limit=<%= limit %>">
                  <i class="fa-solid fa-caret-right text-white"></i>
                </a>
              </li>
            <% } else { %>
              <li class="page-item disabled">
                <span class="page-link bg-dark">
                  <i class="fa-solid fa-caret-right text-white"></i>
                </span>
              </li>
            <% } %>
          </ul>
        </nav>
      </div>
    <% } %>
  </div>
</main>
  </div>

<script>
  async function approveReward(btn) {
    const id = btn.getAttribute('data-id');
    if (!id || btn.disabled) return;
    try {
      const res = await fetch(`/admin/referrals/${id}`, {
        method: "PATCH"
      });
      const data = await res.json();
      if (data.success) {
        btn.innerHTML = 'Approved';
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-success');
        btn.disabled = true;
        setTimeout(() => window.location.reload(), 1000);
      } else {
        // Assuming showAlert is defined globally; fallback to console
        if (typeof showAlert === 'function') {
          showAlert('error', 'Unable to approve: ' + (data.message || 'Unknown error'));
        } else {
          console.error('Unable to approve:', data.message || 'Unknown error');
          alert('Unable to approve: ' + (data.message || 'Unknown error'));
        }
      }
    } catch (error) {
      console.error('Error approving reward:', error);
      if (typeof showAlert === 'function') {
        showAlert('error', 'Network error occurred');
      } else {
        alert('Network error occurred');
      }
    }
  }
</script>

<%- include('../partials/admin/footer.ejs')%>