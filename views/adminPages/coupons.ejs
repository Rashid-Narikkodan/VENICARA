<%- include('../partials/admin/header.ejs')%>
<main class="flex-grow-1 min-vh-100 p-3">
  <div class="container-fluid">
    <div class="row align-items-center mb-5">
      <div class="col-md-6">
        <h1>Coupon Managment</h1>
      </div>
      <div class="col-md-6 d-flex justify-content-end gap-2">
        <form action="/admin/coupons" method="GET" class="d-flex gap-2 w-100">
          <input
            type="text"
            name="search"
            class="form-control w-50"
            placeholder="Search..."
            value="<%= search %>"
          />
          <button class="btn btn-dark">Search</button>
        </form>
        <button class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#addCouponModal">
          Add
        </button>
      </div>
    </div>
    <div class="table-responsive shadow rounded-3 bg-white">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-dark">
          <tr>
            <th class="text-center p-3">No.</th>
            <th class="text-center p-3">Name</th>
            <th class="text-center p-3">Coupon</th>
            <th class="text-center p-3">Minimum</th>
            <th class="text-center p-3">Maximum Discount</th>
            <th class="text-center p-3">Discount</th>
            <th class="text-center p-3">Active from</th>
            <th class="text-center p-3">Active to</th>
            <th class="text-center p-3">Limit</th>
            <th class="text-center p-3">Used</th>
            <th class="text-center p-3">Action</th>
          </tr>
        </thead>
        <tbody>
          <% coupons.forEach(coupon=> { %> <%count++%>
          <tr>
            <td class="text-center"><%= count %></td>
            <td class="text-center"><%= coupon.name%></td>
            <td class="text-center"><%= coupon.code %></td>
            <td class="text-center">₹<%= coupon.minPrice %></td>
            <td class="text-center">₹<%= coupon.maxDiscountAmount %></td>
            <td class="text-center"><%= coupon.discount%>%</td>
            <td class="text-center">
              <%= coupon.createdAt.toLocaleDateString()%>
            </td>
            <td class="text-center">
              <%=coupon.expireAt.toLocaleDateString()%>
            </td>
            <td class="text-center"><%=coupon.limit%></td>
            <td class="text-center"><%=coupon.used%></td>
            <td class="text-center">
              <form
                action="/admin/coupons/<%=coupon._id%>?_method=PATCH"
                method="POST"
                class="d-inline"
              >
                <button
                  type="submit"
                  class="btn btn-sm btn-outline-danger"
                  onclick="return confirm('Are you sure you want to delete this coupon?')"
                >
                  <i class="fa fa-trash"></i>
                </button>
              </form>
            </td>
          </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Add Coupon Modal -->
<div class="modal fade" id="addCouponModal" tabindex="-1" aria-labelledby="addCouponModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content rounded-4">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title" id="addCouponModalLabel">Add New Coupon</h5>
        <button type="button" class="btn-close bg-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
<form id="couponForm" action="/admin/coupons/add" method="POST" >
  <div class="modal-body">
    <div class="row g-3">
      <div class="col-md-6">
        <label for="couponName" class="form-label">Coupon Name</label>
        <input type="text" id="couponName" class="form-control" name="name" placeholder="Summer Time" >
        <div class="text-danger" id="nameError"></div>
      </div>
      
      <div class="col-md-6">
        <label for="couponCode" class="form-label">Coupon Code</label>
        <input type="text" id="couponCode" class="form-control" name="code" placeholder="SMELLNICE" >
        <div class="text-danger" id="codeError"></div>
      </div>
      
      <div class="col-md-6">
        <label for="minPrice" class="form-label">Minimum Purchase</label>
        <input type="number" id="minPrice" class="form-control" name="minPrice" placeholder="100" min="1" >
        <div class="text-danger" id="minPriceError"></div>
      </div>
      
      <div class="col-md-6">
        <label for="maxDiscountAmount" class="form-label">Maximum Discount Amount</label>
        <input type="number" id="maxDiscountAmount" class="form-control" name="maxDiscountAmount" placeholder="3000" min="1" >
        <div class="text-danger" id="maxDiscountError"></div>
      </div>
      
      
      <div class="col-md-6">
        <label for="discount" class="form-label">Discount Percentage</label>
        <input type="number" id="discount" class="form-control" name="discount" placeholder="30" min="1" max="100" >
        <div class="text-danger" id="discountError"></div>
      </div>
      <div class="col-md-6">
        <label for="limit" class="form-label">Limit</label>
        <input type="number" id="limit" class="form-control" name="limit" placeholder="40" min="1" >
        <div class="text-danger" id="limitError"></div>
      </div>
      
      <div class="col-md-6">
        <label for="expireAt" class="form-label">Expire Date</label>
        <input type="date" id="expireAt" class="form-control" name="expireAt" >
        <div class="text-danger" id="expireError"></div>
      </div>
    </div>
  </div>

  <div class="modal-footer">
    <button type="submit" class="btn btn-dark">Create</button>
    <button type="button" class="btn btn-outline-dark" data-bs-dismiss="modal">Cancel</button>
  </div>
</form>
    </div>
  </div>
</div>


  <!-- ////////////////////// -->
  <!-- Pagination -->
  <div class="d-flex justify-content-end">
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-end flex-wrap p-3">
        <!-- Previous Button -->
        <% if (currentPage > 1) { %>
        <li class="page-item">
          <a
            class="page-link bg-dark"
            href="?page=<%= currentPage - 1 %>&limit=<%= limit %>&search=<%= search %>"
          >
            <i class="fa-solid fa-caret-left text-white"></i>
          </a>
        </li>
        <% } else { %>
        <li class="page-item disabled">
          <span class="page-link bg-dark">
            <i class="fa-solid fa-caret-left text-white"></i>
          </span>
        </li>
        <% } %>

        <!-- Left Page (if exists) -->
        <% if (currentPage - 1 >= 1) { %>
        <li class="page-item">
          <a
            class="page-link"
            href="?page=<%= currentPage - 1 %>&limit=<%= limit %>&search=<%= search %>"
          >
            <%= currentPage - 1 %>
          </a>
        </li>
        <% } %>

        <!-- Current Page -->
        <li class="page-item active">
          <span class="page-link bg-white text-dark bcoupon-0">
            <%= currentPage %>
          </span>
        </li>

        <!-- Right Page (if exists) -->
        <% if (currentPage + 1 <= totalPages) { %>
        <li class="page-item">
          <a
            class="page-link"
            href="?page=<%= currentPage + 1 %>&limit=<%= limit %>&search=<%= search %>"
          >
            <%= currentPage + 1 %>
          </a>
        </li>
        <% } %>

        <!-- Next Button -->
        <% if (currentPage < totalPages) { %>
        <li class="page-item">
          <a
            class="page-link bg-dark"
            href="?page=<%= currentPage + 1 %>&limit=<%= limit %>&search=<%= search %>"
          >
            <i class="fa-solid fa-caret-right text-white"></i>
          </a>
        </li>
        <% } else { %>
        <li class="page-item disabled">
          <span class="page-link bg-dark">
            <i class="fa-solid fa-caret-right text-white"></i>
          </span>
        </li>
        <% } %>
      </ul>
    </nav>
  </div>
</main>
</div>
<script>
document.getElementById('couponForm').addEventListener('submit', function (e) {
  e.preventDefault();

  // Get all inputs
  const name = document.getElementById('couponName').value.trim();
  const code = document.getElementById('couponCode').value.trim();
  const minPrice = Number(document.getElementById('minPrice').value);
  const discount = Number(document.getElementById('discount').value);
  const maxDiscountAmount = Number(document.getElementById('maxDiscountAmount').value);
  const limit = Number(document.getElementById('limit').value);
  const expireAt = new Date(document.getElementById('expireAt').value);
  const today = new Date();

  // Get error elements
  const errors = {
    name: document.getElementById('nameError'),
    code: document.getElementById('codeError'),
    minPrice: document.getElementById('minPriceError'),
    discount: document.getElementById('discountError'),
    maxDiscount: document.getElementById('maxDiscountError'),
    limit: document.getElementById('limitError'),
    expire: document.getElementById('expireError'),
  };

  // Reset all errors
  Object.values(errors).forEach(el => el.textContent = '');

  let hasError = false;

  // Validate fields
  if (name.length < 3) {
    errors.name.textContent = 'Coupon name must be at least 3 characters.';
    hasError = true;
  }

  if (!/^[A-Z0-9]+$/i.test(code)) {
    errors.code.textContent = 'Coupon code should contain only letters and numbers.';
    hasError = true;
  }

  if (minPrice <= 0) {
    errors.minPrice.textContent = 'Minimum price must be greater than 0.';
    hasError = true;
  }

  if (discount <= 0 || discount > 100) {
    errors.discount.textContent = 'Discount percentage must be between 1 and 100.';
    hasError = true;
  }

  if (maxDiscountAmount <= 0) {
    errors.maxDiscount.textContent = 'Maximum discount amount must be greater than 0.';
    hasError = true;
  } else if (maxDiscountAmount < (minPrice * discount) / 100) {
    errors.maxDiscount.textContent = 'Max discount amount is too low compared to discount percentage.';
    hasError = true;
  }

  if (limit <= 0) {
    errors.limit.textContent = 'Coupon usage limit must be greater than 0.';
    hasError = true;
  }

  if (!expireAt || expireAt <= today) {
    errors.expire.textContent = 'Please choose a future expiry date.';
    hasError = true;
  }else if (expireAt=='') {
    errors.expire.textContent = 'Please choose a expiry date.';
    hasError = true;
  }

  // If any error found, stop submission
  if (hasError) return;

  // All validations passed — submit form
  e.target.submit();
});
</script>

<%- include('../partials/admin/footer.ejs')%>
